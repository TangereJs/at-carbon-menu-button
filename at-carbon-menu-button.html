<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-carbon-icon-button/at-carbon-icon-button.html">
<link rel="import" href="../at-carbon-menu/at-carbon-menu.html">
<link rel="import" href="../at-core-dropdown/at-core-dropdown.html">

<dom-module id="at-carbon-menu-button">
  <template>
    <style>
      :host {
          display: block;
          box-sizing: border-box;
          width: 40px;
          height: 40px;
      }

      :host .relative-container {
        position: relative;
        display: block;
        height: 44px;

      }
      
      .trigger {
        width: 100%;
        height: 100%;
      }

      :host .absolute-container {
        position: absolute;
      }
    </style>
    <div class="relative-container">
      <div class="absolute-container">
        <at-carbon-icon-button id="trigger" disabled="[[disabled]]" class="trigger" icon="[[icon]]" on-tap="_trigger_onTap" on-keydown="_trigger_onKeydown" color="[[color]]"></at-carbon-icon-button>
        <at-core-dropdown id="dropdown" position="{{position}}" x-offset="{{xOffset}}" y-offset="{{yOffset}}">
          <at-carbon-menu id="menu" items="{{items}}" value="[[value]]" item-view="{{itemView}}"></at-carbon-menu>
        </at-core-dropdown>
      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-carbon-menu-button',
      properties: {
        position: {
          type: String,
          value: "bottomLeft",
          xtype: "enum",
          xvaluelist: [{
            title: "Top Left",
            value: "topLeft"
          }, {
            title: "Top Right",
            value: "topRight"
          }, {
            title: "Bottom Left",
            value: "bottomLeft"
          }, {
            title: "Bottom Right",
            value: "bottomRight"
          }]
        },
        icon: {
          type: String,
          title: "Icon",
          value: "now:menu"
        },
        items: {
          type: Array,
          value: function() {
            return [];
          },
          schema: {
            items: {
              properties: {                
                title: {
                  type: String,
                  title: "Title",
                  "default": ""
                },
                value: {
                  type: String,
                  title: "Value",
                  "default": ""
                },
                icon: {
                  type: String,
                  title: "Icon",
                  "default": ""
                }
              }
            }
          },
          xgridcols: "12"
        },
        value: {
          type: String,
          value: ""
        },
        itemView: {
          type: String,
          xtype: 'code',
          mode: 'liquidmixed',
          value: '<div><at-carbon-icon icon="{{icon}}"></at-carbon-icon>{{title}}</div>'
        },
        xOffset: {
          type: Number,
          value: 0
        },
        yOffset: {
          type: Number,
          value: 0
        },
        color: {
          type: String,
          value: ""
        },

        disabled: {
          type: Boolean,
          value: false
        }
      },

      /********************************************************************************/
      /* _keyCodes, _trigger_onTap, _trigger_onKeydown, _enterSpaceGuard and menu.addEventListener('value-changed')
      /* All right, what is going on here
      /* Its not possible to give at-carbon-menu keyboard focus programmatically.
      /* at-carbon-menu has tabindex = 0, but at-carbon-menu.focus() doesn't do anything
      /* Right how at-carbon-menu.insertPoint has tabindex = 0, and a custom focus function that focuses insertPoint,
      /* but still at-carbon-menu doesn't have keyboard focus. So far only way at-carbon-menu gets keyboard focus is TAB key
      /* as a workaround for this limitation of HTML TAB and ESC keys are handled in at-carbon-menu-button
      /* every other key is forwarded to at-carbon-menu
      /********************************************************************************/

      _keyCodes: {
        ESC: 27,
        TAB: 9,
        ARROW_UP: 38,
        ARROW_DOWN: 40,
        ENTER: 13,
        SPACE: 32
      },

      _trigger_onTap: function (event) {
        this.$.menu._host_onTap(event);
      },

      _trigger_onKeydown: function (event) {
        var menu = this.$.menu;
        var dropdown = this.$.dropdown;

        var keyCodes = this._keyCodes;
        var keyCode = event.which;

        switch (keyCode) {
          case this._keyCodes.TAB:
            if (dropdown.isOpen()){
              menu._select();
              dropdown.hide();
            }
            break;
          case keyCodes.ENTER:
          case keyCodes.SPACE:
            if (dropdown.isOpen()){
              this._enterSpaceGuard = true;
              menu._select();
              dropdown.hide();
            }
            break;
          case this._keyCodes.ESC:
            dropdown.hide();
            break;
          default:
            menu._host_onKeydown(event);
            break;
        }
      },

      ready: function() {
        var trigger = this.$.trigger;
        var dropdown = this.$.dropdown;
        var menu = this.$.menu;
        var self = this;

        trigger.addEventListener('tap', function(event) {
          if (self._enterSpaceGuard) {
            self._enterSpaceGuard = false;
            return ;
          }
          dropdown.toggle(trigger, event);
        });

        menu.addEventListener('value-changed', function(event) {
          dropdown.hide();
          // *ij* with value notify true, repeated clicks on the same menu item do not trigger value-changed
          // when value-changed is fired manually repeated clicks trigger value-changed as expected
          self.fire('value-changed', { value: event.detail.value }, { bubbles: false });
        });
      }
    });
  </script>
</dom-module>
