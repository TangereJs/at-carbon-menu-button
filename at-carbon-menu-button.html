<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-carbon-icon-button/at-carbon-icon-button.html">
<link rel="import" href="../at-carbon-menu/at-carbon-menu.html">
<link rel="import" href="../at-core-dropdown/at-core-dropdown.html">
<link rel="import" href="../at-core-bottom-sheet/at-core-bottom-sheet.html">

<dom-module id="at-carbon-menu-button">
  <template>
    <style>
      :host {
          display: block;
          box-sizing: border-box;
          width: 40px;
          height: 40px;
      }
      
      :host([hidden]) {
        display: none !important;
      }

      :host .relative-container {
        position: relative;
        display: block;
        height: 100%;
      }
      
      .trigger {
        width: 100%;
        height: 100%;
      }

      :host .absolute-container {
        width: 100%;
        height: 100%;
        position: absolute;
      }

      .item-container {
        white-space: nowrap;
      }

      .icon-class {
        padding: 0 12px 0 0;
      }

      .title-class {
        vertical-align: middle;        
        overflow: hidden;
        white-space: nowrap;
      }
      
    </style>
    <div class="relative-container">
      <div class="absolute-container">
        <at-carbon-icon-button id="trigger" badge-label="[[badgeLabel]" badge-color="[[badgeColor]]" disabled="[[disabled]]" class="trigger" icon="[[icon]]" on-keydown="_trigger_onKeydown" color="[[color]]"></at-carbon-icon-button>
        <at-core-dropdown id="dropdown" position="{{position}}" x-offset="{{xOffset}}" y-offset="{{yOffset}}" on-open-changed="_handleDropdownOpenChanged" arrow>
          <at-carbon-menu id="carbonMenu" items="{{items}}" value="{{value}}" item-view="{{itemView}}"></at-carbon-menu>
        </at-core-dropdown>
        <at-core-bottom-sheet id="bottomSheet" items="{{items}}" value="{{value}}" item-view="{{itemView}}"  on-open-changed="_handleBottomSheetOpenChanged"></at-core-bottom-sheet>
      </div>
    </div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-carbon-menu-button',
      properties: {
        position: {
          type: String,
          value: "bottomLeft",
          xtype: "enum",
          xvaluelist: [{
            title: "Top Left",
            value: "topLeft"
          }, {
            title: "Top Right",
            value: "topRight"
          }, {
            title: "Bottom Left",
            value: "bottomLeft"
          }, {
            title: "Bottom Right",
            value: "bottomRight"
          }]
        },
        icon: {
          type: String,
          title: "Icon",
          value: "now:menu"
        },
        items: {
          type: Array,
          value: function() {
            return [];
          },
          schema: {
            items: {
              properties: {                
                value: {
                  type: String,
                  title: "Value",
                  "default": ""
                },
                title: {
                  type: String,
                  title: "Title",
                  "default": ""
                },
                icon: {
                  type: String,
                  title: "Icon",
                  "default": ""
                }
              }
            }
          },
          xgridcols: "12"
        },
        value: {
          type: String,
          value: ""
        },
        itemView: {
          type: String,
          xtype: 'code',
          mode: 'liquidmixed',
          value: '<div class="item-container at-carbon-menu-button"><at-carbon-icon icon="{{icon}}" class="icon-class at-carbon-menu-button"></at-carbon-icon><span class="title-class at-carbon-menu-button">{{title}}</span></div>'
        },
        xOffset: {
          type: Number,
          value: 0
        },
        yOffset: {
          type: Number,
          value: 0
        },
        color: {
          type: String,
          value: ""
        },

        disabled: {
          type: Boolean,
          value: false
        },

        open: {
          type: Boolean,
          value: false,
          observer: '_openChanged',
          notify: true
        },

        badgeLabel: {
          type: String,
          value: ''
        },

        badgeColor: {
          type: String,
          value: ''
        },

        renderMode: {
          type: String,
          value: '0',
          observer: '_renderModeChanged',
          xtype: "enum",
          xvaluelist: [{
            title: "default",
            value: "0"
          }, {
            title: "desktop",
            value: "1"
          }, {
            title: "mobile",
            value: "2"
          }],
        },
      },

      /********************************************************************************/
      /* _keyCodes, _trigger_onTap, _trigger_onKeydown, _enterSpaceGuard and menu.addEventListener('value-changed')
      /* All right, what is going on here
      /* Its not possible to give at-carbon-menu keyboard focus programmatically.
      /* at-carbon-menu has tabindex = 0, but at-carbon-menu.focus() doesn't do anything
      /* Right how at-carbon-menu.insertPoint has tabindex = 0, and a custom focus function that focuses insertPoint,
      /* but still at-carbon-menu doesn't have keyboard focus. So far only way at-carbon-menu gets keyboard focus is TAB key
      /* as a workaround for this limitation of HTML TAB and ESC keys are handled in at-carbon-menu-button
      /* every other key is forwarded to at-carbon-menu
      /********************************************************************************/

      _keyCodes: {
        ESC: 27,
        TAB: 9,
        ARROW_UP: 38,
        ARROW_DOWN: 40,
        ENTER: 13,
        SPACE: 32
      },

      _trigger_onKeydown: function (event) {
        var menu = this.$.carbonMenu;
        var dropdown = this.$.dropdown;

        var keyCodes = this._keyCodes;
        var keyCode = event.which;

        switch (keyCode) {

          case this._keyCodes.TAB:
            if (dropdown.isOpen()){
              menu._select();
              dropdown.hide();
            }
            break;

          case keyCodes.ENTER:
          case keyCodes.SPACE:
            if (dropdown.isOpen()){
              this._enterSpaceGuard = true;
              menu._select();
              dropdown.hide();
            }
            break;

          case this._keyCodes.ESC:
            dropdown.hide();
            break;

          default:
            menu._host_onKeydown(event);
            break;
        }
      },

      ready: function() {
        var trigger = this.$.trigger;
        var dropdown = this.$.dropdown;
        var menu = this.$.carbonMenu;
        var self = this;

        trigger.addEventListener('tap', function(event) {
          if (self._enterSpaceGuard) {
            self._enterSpaceGuard = false;
            return ;
          }
          dropdown.toggle(trigger, event);
        });

        menu.addEventListener('value-changed', function(event) {
          dropdown.hide();
          self.value = event.detail.value;

          var detail = { value: event.detail.value };
          // *ij* with value notify true, repeated clicks on the same menu item do not trigger value-changed
          // when value-changed is fired manually repeated clicks trigger value-changed as expected
          self.fire('value-changed', detail, { bubbles: false });

          // allow event handlers to update or reset value
          if (this.value != detail.value) {
            this.value = detail.value;            
          }
        });
      },

      _openChanged: function(newValue, oldValue) {
        var trigger = this.$.trigger;
        var dropdown = this.$.dropdown;
        var bottomSheet = this.$.bottomSheet;

        if(newValue == true) {
          if(this.renderMode == '1') {
            dropdown.open = true;
            dropdown.updateDropdownPosition(trigger);
          }

          if(this.renderMode == '2') {
            bottomSheet.open = true;
          }

          if(this.renderMode == '0') {
            if(Tangere.session.browser.mobile == false) {
              dropdown.open = true;
              dropdown.updateDropdownPosition(trigger);
            } else {
              bottomSheet.open = true;
            }
          }

        } else {
          dropdown.open = false;
          bottomSheet.open = false;
        }
      },

      _renderModeChanged: function (newValue, oldValue) {
        var dropdown = this.$.dropdown;
        var bottomSheet = this.$.bottomSheet;

        // default - if mobile == true -> behave like mobile, otherwise -> behave like desktop
        if (newValue == '0') {
          if(Tangere.session.browser.mobile == true) {
            newValue = 2;
          } else {
            newValue = 1;
          }
        }

        // desktop render mode
        if (newValue == '1') {
          if(this.open == true) {
            dropdown.open = true;
            dropdown.updateDropdownPosition(this.$.trigger);
          }
          if(this.open == false) dropdown.open = false;
        }

        // mobile render mode
        if (newValue == '2') {
          if(this.open == true) bottomSheet.open = true;
          if(this.open == false) bottomSheet.open = false;
        }
      },

      _handleDropdownOpenChanged: function(event) {
        if(this.open == event.detail.value) return;
        this.open = event.detail.value;
      },

      _handleBottomSheetOpenChanged: function(event) {
        if(this.open == event.detail.value) return;
        this.open = event.detail.value;
      }

      // TO DO - value doesn't reflrect properly when selected from at-core-bottom-sheet.

    });
  </script>
</dom-module>
